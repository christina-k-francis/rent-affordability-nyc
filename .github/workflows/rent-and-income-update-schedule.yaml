name: Rent and Income Data Update Schedule 

on:
  schedule:
    - cron: '0 2 1 * *' # will run on the 1st of every month at 2am
  workflow_dispatch: # allows manual triggers

jobs:
  run-etl-scripts:
    runs-on: ubuntu-latest
    env:
      GOOGLE_CREDENTIALS_JSON: ${{ secrets.GOOGLE_CREDENTIALS_JSON }}
      CENSUS_API: ${{ secrets.CENSUS_API_KEY }}
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas google-cloud-bigquery google-auth-oauthlib pyarrow pandas-gbq
      
      - name: Run Streeteast Rent ETL
        id: streeteasy_etl
        run: |
          cd ETL
          python etl_streeteasy_rent_to_bq.py

      - name: Run U.S. Census Income ETL
        id: census_etl
        run: |
          cd ETL
          python etl_us_census_income_to_bq.py

      - name: Query latest data availability
        id: data_check
        run: |
          python3 << 'EOF'
          import os
          import json
          from google.cloud import bigquery
          from google.oauth2 import service_account
          from datetime import datetime

          # Setup credentials
          PROJECT_ID = "rent-affordability"
          DATASET_ID = "nyc_analysis"
          
          service_account_info = json.loads(os.environ["GOOGLE_CREDENTIALS_JSON"])
          credentials = service_account.Credentials.from_service_account_info(service_account_info)
          client = bigquery.Client(project=PROJECT_ID, credentials=credentials)
          
          # Query latest rent data date
          rent_query = f"""
          SELECT MAX(DATE(CONCAT(CAST(year AS STRING), '-', LPAD(CAST(month AS STRING), 2, '0'), '-01'))) as latest_rent_date
          FROM `{PROJECT_ID}.{DATASET_ID}.staging_median_rent`
          """
          
          rent_result = client.query(rent_query).result()
          rent_date = list(rent_result)[0]['latest_rent_date']
          
          # Query latest income data date
          income_query = f"""
          SELECT MAX(year) as latest_income_year
          FROM `{PROJECT_ID}.{DATASET_ID}.staging_median_income`
          """
          
          income_result = client.query(income_query).result()
          income_year = list(income_result)[0]['latest_income_year']
          
          # Output results
          print(f"::Data Availability Report::")
          print(f"Latest StreetEasy Rent Data: {rent_date}")
          print(f"Latest U.S. Census Income Data: {income_year}")
          
          # Save to environment for use in summary
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f"rent_date={rent_date}\n")
              f.write(f"income_year={income_year}\n")
          
          EOF